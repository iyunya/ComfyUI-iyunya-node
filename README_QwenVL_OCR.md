# 阿里云百炼文字识别插件 (Qwen-VL OCR)

这是一个基于阿里云百炼大模型服务的图片文字识别ComfyUI自定义节点插件。

## 功能特点

- 🔍 **智能文字识别**: 基于阿里云百炼qwen-vl-max-latest模型进行高精度OCR识别
- 📍 **坐标定位**: 自动识别文字区域并返回边界框坐标
- 🌐 **多语言支持**: 支持中文、英文、日语、韩语等多种语言识别和翻译
- 🎨 **可视化标注**: 在原图上用红线标记识别出的文字区域
- 🎭 **Mask生成**: 根据识别区域生成对应的遮罩图像
- 📊 **JSON输出**: 结构化的识别结果输出

## 安装要求

### Python依赖
```bash
pip install requests pillow numpy torch opencv-python
```

### 阿里云百炼API Key
1. 注册阿里云账号并开通百炼服务
2. 获取API Key (格式: sk-xxx)
3. 确保账号有足够的调用额度

## 节点说明

### 输入参数

#### 必需参数:
- **image**: 输入图像 (IMAGE类型)
- **api_key**: 阿里云百炼API密钥 (STRING类型)
  - 格式: `sk-xxx`
  - 需要有百炼服务的调用权限
- **custom_prompt**: 自定义识别提示词 (STRING类型)
  - 默认: `识别图片中的文字并翻译，附带标注box坐标，返回json {"bbox_2d":[x1,y1,x2,y2],"text_content":"翻译内容"}`
  - 可以根据需要自定义识别要求
- **model**: 选择使用的模型 (下拉选择)
  - `qwen-vl-max-latest` (推荐，最新版本)
  - `qwen-vl-max`
  - `qwen-vl-plus-latest`
  - `qwen-vl-plus`

#### 可选参数:
- **api_base_url**: API基础URL (STRING类型)
  - 默认: `https://dashscope.aliyuncs.com/compatible-mode/v1`
  - 一般不需要修改

### 输出结果

插件会返回3个输出:

1. **marked_image** (IMAGE): 标记了识别区域的图像
   - 在原图上用红色边界框标记文字区域
   - 可选择在框上方显示识别文字

2. **text_mask** (MASK): 文字区域的遮罩
   - 黑色背景，白色标记文字区域
   - 可用于后续图像处理

3. **ocr_result_json** (STRING): 识别结果JSON
   ```json
   {
     "status": "success",
     "model_used": "qwen-vl-max-latest",
     "ocr_results": [
       {
         "bbox_2d": [x1, y1, x2, y2],
         "text_content": "识别的文字内容"
       }
     ],
     "total_detections": 1,
     "original_response": "原始API响应"
   }
   ```

## 使用示例

### 基本使用流程

1. **加载图片**: 使用Load Image节点载入需要识别的图片
2. **配置参数**: 
   - 输入阿里云百炼API Key
   - 选择合适的模型
   - 根据需要调整提示词
3. **连接节点**: 将图片连接到OCR节点的image输入
4. **运行识别**: 执行工作流开始识别
5. **查看结果**: 
   - 通过Preview Image查看标记结果
   - 通过Show Text查看JSON结果

### 自定义提示词示例

#### 纯文字识别:
```
请识别图片中的所有文字，按从上到下、从左到右的顺序返回。对每个文字区域返回JSON格式: {"bbox_2d":[x1,y1,x2,y2],"text_content":"文字内容"}
```

#### 多语言翻译:
```
识别图片中的文字并翻译成英文，返回JSON格式: {"bbox_2d":[x1,y1,x2,y2],"text_content":"翻译后的英文内容"}
```

#### 表格内容提取:
```
识别图片中的表格内容，按行列结构提取文字，返回JSON格式: {"bbox_2d":[x1,y1,x2,y2],"text_content":"单元格内容","row":行号,"col":列号}
```

#### 特定内容识别:
```
只识别图片中的价格、电话号码、日期等关键信息，返回JSON格式: {"bbox_2d":[x1,y1,x2,y2],"text_content":"关键信息","type":"价格|电话|日期"}
```

## 错误处理

插件包含完善的错误处理机制:

- **API调用失败**: 会在JSON结果中返回错误信息
- **解析失败**: 会返回原始响应内容和默认格式结果
- **网络超时**: 设置60秒超时时间，防止长时间等待
- **参数验证**: 检查API Key是否有效

## 注意事项

1. **API费用**: 使用阿里云百炼API会产生费用，请注意监控使用量
2. **图片大小**: 建议图片尺寸适中，过大的图片会增加处理时间和费用
3. **网络环境**: 需要能够访问阿里云API服务的网络环境
4. **坐标系统**: 返回的坐标为像素坐标，(x1,y1)为左上角，(x2,y2)为右下角
5. **中文支持**: 插件完全支持中文输入输出

## 技术特性

- **Base64编码**: 自动将图片转换为Base64格式发送给API
- **智能解析**: 能够从不同格式的API响应中提取坐标和文字信息
- **容错能力**: 即使API返回格式不标准也能尽量解析出有用信息
- **日志记录**: 详细的日志记录便于调试和问题排查

## 更新日志

### v1.0.0 (2024-12-20)
- 首次发布
- 支持阿里云百炼qwen-vl系列模型
- 实现图片文字识别和边界框标注
- 支持自定义提示词和多种输出格式

## 许可证

本插件遵循Apache-2.0许可证，与ComfyUI-iyunya-nodes主项目保持一致。 